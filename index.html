import React, { useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Cell,
  ResponsiveContainer,
} from "recharts";
import { Card, CardContent } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Input } from "@/components/ui/input";

/**
 * Design goal
 * - 모든 수치를 "완전 수정 가능"
 * - 각 항목이 무엇을 의미하는지 즉시 이해 가능
 * - 병원장/세일즈 설명용 ROI 시뮬레이터
 */

const currency = (v) => `¥${Math.round(v).toLocaleString()}`;

export default function DentalCTROICalculator() {
  /* ---------------- Equipment ---------------- */
  const [equipmentPrice, setEquipmentPrice] = useState(7_680_000);
  const WARRANTY_MONTHS = 120;

  /* ---------------- Income ---------------- */
  const [income, setIncome] = useState({
    pano: { fee: 1500, perDay: 3, days: 22 },
    ctIns: { fee: 3500, perDay: 2, days: 22 },
    ctSelf: { fee: 15000, perDay: 1, days: 22 },
    ceph: { fee: 2000, perDay: 1, days: 22 },
    other: 0,
  });

  /* ---------------- Cost ---------------- */
  const [cost, setCost] = useState({
    maintenance: 30000,
    consumables: 20000,
    electricity: 15000,
    rent: 200000,
    rentRatio: 30,
    doctor: 800000,
    doctorRatio: 10,
    staff: 300000,
    staffRatio: 20,
    other: 0,
  });

  /* ---------------- Calculations ---------------- */
  const monthlyIncome = useMemo(() => {
    const calc = (i) => i.fee * i.perDay * i.days;
    const pano = calc(income.pano);
    const ctIns = calc(income.ctIns);
    const ctSelf = calc(income.ctSelf);
    const ceph = calc(income.ceph);
    const total = pano + ctIns + ctSelf + ceph + income.other;
    return { pano, ctIns, ctSelf, ceph, total };
  }, [income]);

  const monthlyCost = useMemo(() => {
    const rent = cost.rent * (cost.rentRatio / 100);
    const doctor = cost.doctor * (cost.doctorRatio / 100);
    const staff = cost.staff * (cost.staffRatio / 100);
    const total =
      cost.maintenance +
      cost.consumables +
      cost.electricity +
      rent +
      doctor +
      staff +
      cost.other;
    return { rent, doctor, staff, total };
  }, [cost]);

  const net = monthlyIncome.total - monthlyCost.total;
  const payback = net > 0 ? Math.ceil(equipmentPrice / net) : 0;
  const netMonths = WARRANTY_MONTHS - payback;
  const netProfit = net * netMonths;

  const chartData = [
    { name: "収入", value: monthlyIncome.total },
    { name: "費用", value: monthlyCost.total },
    { name: "純利益", value: net },
  ];

  /* ---------------- UI ---------------- */
  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">
            Vatech CT ROI シミュレーター
          </h1>
          <p className="text-gray-500 mt-1">
            各項目を自由に調整し、投資回収期間と利益構造を可視化
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <KPI title="月間純利益" value={currency(net)} accent />
          <KPI title="投資回収期間" value={`${payback} ヶ月`} />
          <KPI title="ワランティ内純利益" value={currency(netProfit)} />
        </div>

        <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <Section title="月間収入">
            <IncomeEditor
              label="PANO（パノラマ撮影）"
              description="パノラマX線撮影による保険収入"
              data={income.pano}
              onChange={(v) => setIncome({ ...income, pano: v })}
            />
            <IncomeEditor
              label="CT（保険）"
              description="保険適用CT撮影による収入"
              data={income.ctIns}
              onChange={(v) => setIncome({ ...income, ctIns: v })}
            />
            <IncomeEditor
              label="CT（自費）"
              description="インプラント・精密診断等の自費CT撮影"
              data={income.ctSelf}
              onChange={(v) => setIncome({ ...income, ctSelf: v })}
            />
            <IncomeEditor
              label="CEPH"
              description="矯正用セファロ撮影による収入"
              data={income.ceph}
              onChange={(v) => setIncome({ ...income, ceph: v })}
            />
            <LabeledInput
              label="その他収入"
              description="紹介料・臨時撮影など"
              value={income.other}
              onChange={(v) => setIncome({ ...income, other: v })}
            />
            <Separator />
            <TotalRow label="収入合計" value={monthlyIncome.total} />
          </Section>

          <Section title="月間費用">
            <LabeledInput
              label="保守メンテナンス"
              value={cost.maintenance}
              onChange={(v) => setCost({ ...cost, maintenance: v })}
            />
            <LabeledInput
              label="消耗品"
              description="（バイトビニル、手袋、アルコール）"
              value={cost.consumables}
              onChange={(v) => setCost({ ...cost, consumables: v })}
            />
            <LabeledInput
              label="電気代"
              description="CT稼働分のみ想定"
              value={cost.electricity}
              onChange={(v) => setCost({ ...cost, electricity: v })}
            />
            <OccupancyBlock
              title="家賃配分"
              description="院内設置面積分のみ按分"
              base={cost.rent}
              ratio={cost.rentRatio}
              onBaseChange={(v) => setCost({ ...cost, rent: v })}
              onRatioChange={(v) =>
                setCost({ ...cost, rentRatio: v })
              }
              result={monthlyCost.rent}
            />
            <OccupancyBlock
              title="医師人件費配分"
              description="CT診断・説明にかかる稼働分"
              base={cost.doctor}
              ratio={cost.doctorRatio}
              onBaseChange={(v) => setCost({ ...cost, doctor: v })}
              onRatioChange={(v) =>
                setCost({ ...cost, doctorRatio: v })
              }
              result={monthlyCost.doctor}
            />
            <OccupancyBlock
              title="スタッフ人件費配分"
              description="撮影・運用対応分"
              base={cost.staff}
              ratio={cost.staffRatio}
              onBaseChange={(v) => setCost({ ...cost, staff: v })}
              onRatioChange={(v) =>
                setCost({ ...cost, staffRatio: v })
              }
              result={monthlyCost.staff}
            />
            <LabeledInput
              label="その他費用"
              description="通信費・雑費など"
              value={cost.other}
              onChange={(v) => setCost({ ...cost, other: v })}
            />
            <Separator />
            <TotalRow label="費用合計" value={monthlyCost.total} />
          </Section>

          <Section title="投資・収支バランス">
            <div className="space-y-2">
              <p className="font-medium text-sm">CT装置価格</p>
              <p className="text-xs text-gray-500">
                初期導入費用（本体・基本構成）
              </p>
              <Input
                type="text"
                inputMode="numeric"
                value={equipmentPrice}
                onChange={(e) =>
                  setEquipmentPrice(Number(e.target.value))
                }
              />
            </div>

            <Separator />

            <ResponsiveContainer width="100%" height={240}>
              <BarChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis tickFormatter={(v) => `${v / 10000}万`} />
                <Tooltip formatter={(v) => currency(v)} />
                <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                  {chartData.map((_, i) => (
                    <Cell
                      key={i}
                      fill={i === 2 ? "#dc2626" : "#9ca3af"}
                    />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </Section>
        </div>
      </div>
    </div>
  );
}

/* ---------------- Components ---------------- */

function KPI({ title, value, accent }) {
  return (
    <Card className={accent ? "border-red-600" : ""}>
      <CardContent className="p-4">
        <p className="text-sm text-gray-500">{title}</p>
        <p className={`text-2xl font-bold ${accent ? "text-red-600" : ""}`}>
          {value}
        </p>
      </CardContent>
    </Card>
  );
}

function Section({ title, children }) {
  return (
    <Card>
      <CardContent className="p-5 space-y-3">
        <h2 className="font-semibold text-lg">{title}</h2>
        {children}
      </CardContent>
    </Card>
  );
}

function LabeledInput({ label, description, value, onChange }) {
  return (
    <div className="space-y-1">
      <p className="text-sm font-medium">{label}</p>
      {description && (
        <p className="text-xs text-gray-500">{description}</p>
      )}
      <Input
        type="text"
        inputMode="numeric"
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
      />
    </div>
  );
}

function IncomeEditor({ label, description, data, onChange }) {
  return (
    <div className="rounded-lg bg-gray-50 p-4 space-y-3">
      <div>
        <p className="font-medium text-sm">{label}</p>
        <p className="text-xs text-gray-500">{description}</p>
        <p className="text-xs text-gray-400 mt-1">
          単価 × 1日撮影回数 × 月間稼働日数
        </p>
      </div>
      <div className="grid grid-cols-3 gap-2">
        <Input
          type="text"
          inputMode="numeric"
          value={data.fee}
          onChange={(e) =>
            onChange({ ...data, fee: Number(e.target.value) })
          }
        />
        <Input
          type="text"
          inputMode="numeric"
          value={data.perDay}
          onChange={(e) =>
            onChange({ ...data, perDay: Number(e.target.value) })
          }
        />
        <Input
          type="text"
          inputMode="numeric"
          value={data.days}
          onChange={(e) =>
            onChange({ ...data, days: Number(e.target.value) })
          }
        />
      </div>
    </div>
  );
}

function OccupancyBlock({
  title,
  description,
  base,
  ratio,
  onBaseChange,
  onRatioChange,
  result,
}) {
  return (
    <div className="rounded-lg bg-gray-50 p-3 space-y-2">
      <p className="font-medium text-sm">{title}</p>
      <p className="text-xs text-gray-500">{description}</p>
      <div className="grid grid-cols-2 gap-2">
        <Input
          type="text"
          inputMode="numeric"
          value={base}
          onChange={(e) => onBaseChange(Number(e.target.value))}
        />
        <Input
          type="text"
          inputMode="numeric"
          value={ratio}
          onChange={(e) => onRatioChange(Number(e.target.value))}
        />
      </div>
      <p className="text-xs text-gray-500">
        配分後: {currency(result)}
      </p>
    </div>
  );
}

function TotalRow({ label, value }) {
  return (
    <div className="flex justify-between font-semibold pt-2">
      <span>{label}</span>
      <span className="text-red-600">{currency(value)}</span>
    </div>
  );
}


